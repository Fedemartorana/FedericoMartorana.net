<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quadra Translator</title>

  <!-- Glyph library -->
  <script src="./quadra-glyphs.js"></script>

  <style>
    :root{
      --bg:#ffffff;

      /* from your screenshots: desaturated pastel blue/grey */
      --ink:#8FA3AE;          /* primary text/UI */
      --ink-2:#A7B7C0;        /* secondary */
      --hair: rgba(143,163,174,.28);

      --sans: "Helvetica Neue", Helvetica, Arial, system-ui, -apple-system, Segoe UI, Roboto;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --maxw: 1400px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      overflow-x:hidden;
    }

    /* page */
    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 0 28px;
      min-height: 100vh;
      display:grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 1fr auto;
      column-gap: 36px;
    }

    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        padding: 0 18px;
        row-gap: 24px;
      }
    }

    /* left legend */
    aside{
      padding-top: 34px;
    }
    .legend-title{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ink);
      margin-bottom: 10px;
    }
    .legend{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }
    .legend-item{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .legend-item svg{
      width: 42px;
      height: 42px;
      opacity: .95;
    }
    .legend-name{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--ink);
      line-height: 1.2;
    }
    .legend-desc{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-2);
      line-height: 1.35;
      margin-top: 3px;
    }

    /* main */
    main{
      padding-top: 34px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 18px;
      min-height: 72vh;
    }

    .title{
      margin:0;
      font-size: clamp(44px, 6.2vw, 96px);
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--ink);
      text-align:center;
      line-height: 0.98;
    }

    .desc{
      max-width: 760px;
      text-align:center;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.6;
      color: var(--ink-2);
      margin: 0;
    }

    .inputBlock{
      width: min(820px, 92%);
      display:flex;
      flex-direction:column;
      gap: 16px;
      margin-top: 10px;
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      border: 1px solid var(--hair);
      border-radius: 0;
      outline: none;
      padding: 16px 16px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--ink);
      background: transparent;
    }
    textarea::placeholder{ color: rgba(143,163,174,.55); }

    .btnRow{
      display:flex;
      justify-content:center;
    }

    button{
      width: min(520px, 92%);
      padding: 18px 18px;
      border: 1px solid var(--ink);
      background: transparent;
      color: var(--ink);
      font-family: var(--sans);
      font-size: 18px;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 600;
      cursor:pointer;
      transition: transform .04s ease, opacity .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    /* bottom output */
    .bottom{
      grid-column: 1 / span 2;
      padding: 16px 0 18px 0;
      border-top: 1px solid var(--hair);
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 160px;
    }
    @media (max-width: 980px){
      .bottom{ grid-column: 1; }
    }

    .outLabel{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ink);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
    }

    .outLabel .api{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-2);
      letter-spacing: .02em;
      text-transform:none;
    }

    .quadraLine{
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
      align-items:center;
      padding: 10px 0;
      min-height: 84px;
    }
    .word{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .sep{
      font-family: var(--mono);
      color: rgba(143,163,174,.55);
      letter-spacing:.08em;
      user-select:none;
    }

    /* subtle reveal */
    .fadeIn{
      animation: fadeIn .22s ease-out;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(2px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* make glyph strokes pastel too if glyph lib uses black strokes */
    .quadraLine svg line,
    .quadraLine svg rect,
    .quadraLine svg circle,
    .quadraLine svg path{
      stroke: var(--ink) !important;
      fill: currentColor;
    }
    /* but if svg is built with explicit fill="#000", we can't override reliably;
       in that case, update quadra-glyphs.js to use currentColor/stroke currentColor. */
    .quadraLine svg{ color: var(--ink); }
    aside svg{ color: var(--ink); }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- LEFT: legend -->
    <aside>
      <div class="legend-title">Legend</div>
      <div class="legend" id="legend"></div>
    </aside>

    <!-- CENTER: translator -->
    <main>
      <h1 class="title">Quadra Translator</h1>
      <p class="desc">
        Quadra non “traduce” parole: riduce il linguaggio a unità di intenzione.
        Ogni frase diventa una composizione di concetti — entità, agenzia, stato, tempo —
        come una grammatica geometrica che descrive relazioni invece che suoni.
      </p>

      <div class="inputBlock">
        <textarea id="itInput" placeholder="Scrivi una frase… (es. 'bottiglia piena vicino al luogo')"></textarea>
        <div class="btnRow">
          <button id="btnTranslate">Translate</button>
        </div>
      </div>
    </main>

    <!-- BOTTOM: output -->
    <section class="bottom">
      <div class="outLabel">
        <span>Output Quadra</span>
        <span class="api" id="apiLabel">API: …</span>
      </div>
      <div class="quadraLine" id="quadraOutput"></div>
    </section>
  </div>

<script>
  /* =========================
     CONFIG
     ========================= */
  const API_BASE = "https://quadra-api.quadra-fm.workers.dev";

  /* =========================
     GLYPH LIB BRIDGE
     ========================= */
  const Q = window.QUADRA || window.QuadraGlyphs || null;

  function assertGlyphLib(){
    if(!Q) throw new Error("quadra-glyphs.js non caricato (QUADRA/QuadraGlyphs mancante).");
    if(typeof Q.svgGlyph !== "function") throw new Error("svgGlyph() mancante.");
    if(typeof Q.parseQuadraString !== "function") throw new Error("parseQuadraString() mancante.");
  }

  /* =========================
     DOM
     ========================= */
  const itInput = document.getElementById("itInput");
  const btnTranslate = document.getElementById("btnTranslate");
  const quadraOutput = document.getElementById("quadraOutput");
  const legendEl = document.getElementById("legend");
  const apiLabel = document.getElementById("apiLabel");

  /* =========================
     API
     ========================= */
  async function apiHealth(){
    try{
      const r = await fetch(`${API_BASE}/`, { method:"GET" });
      const t = await r.text();
      const ok = r.ok && (t || "").includes("quadra-api ok");
      apiLabel.textContent = ok ? "API: online" : "API: risposta inattesa";
    }catch(e){
      apiLabel.textContent = "API: offline";
    }
  }

  async function apiTranslate(text){
    const r = await fetch(`${API_BASE}/translate`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ text, autosave:false })
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data?.error || "translate_failed");
    return data;
  }

  /* =========================
     RENDER
     ========================= */
  function renderWords(parsed){
    quadraOutput.innerHTML = "";
    quadraOutput.classList.remove("fadeIn");
    // word separation: the parser returns array of words with tokens
    parsed.forEach((w, idx) => {
      const word = document.createElement("div");
      word.className = "word";
      w.tokens.forEach((t, i) => {
        const cell = document.createElement("div");
        cell.innerHTML = Q.svgGlyph(t, { negate: w.opts?.[i]?.negate === true });
        word.appendChild(cell);
      });
      quadraOutput.appendChild(word);

      if(idx !== parsed.length - 1){
        const sep = document.createElement("div");
        sep.className = "sep";
        sep.textContent = "⟂";
        quadraOutput.appendChild(sep);
      }
    });
    quadraOutput.classList.add("fadeIn");
  }

  function legendMeaning(token){
    const map = {
      OGGETTO:"entità oggettuale",
      PERSONA:"agente / persona",
      LUOGO:"spazio / luogo",
      ATTIVO:"agenzia attiva",
      PASSIVO:"agenzia passiva",
      FERMO:"stato stabile",
      MOVIMENTO:"stato dinamico",
      PRESENTE:"presenza / tempo",
      ASSENTE:"assenza (negazione interna)",
      RELAZIONE:"relazione",
      INIZIO:"inizio",
      FINE:"fine",
      CONTENITORE:"contenitore",
      APERTO:"aperto",
      CHIUSO:"chiuso",
      PIENO:"pieno",
      VUOTO:"vuoto",
      DENTRO:"dentro",
      FUORI:"fuori",
      VICINO:"vicino",
      LONTANO:"lontano",
      TRASFORMAZIONE:"trasformazione",
      CAUSA:"causa",
      SCOPO:"scopo",
      POSSESSO:"possesso",
      POSSIBILE:"possibile",
      DOVERE:"dovere"
    };
    return map[token] || "concetto";
  }

  function renderLegend(){
    const defs = Q.GLYPH_DEFS || {};
    const tokens = Object.keys(defs);

    legendEl.innerHTML = "";
    tokens.forEach(t => {
      const item = document.createElement("div");
      item.className = "legend-item";
      item.innerHTML = `
        <div>${Q.svgGlyph(t)}</div>
        <div>
          <div class="legend-name">${t}</div>
          <div class="legend-desc">${legendMeaning(t)}</div>
        </div>
      `;
      legendEl.appendChild(item);
    });
  }

  /* =========================
     ACTIONS
     ========================= */
  async function doTranslate(){
    assertGlyphLib();
    const text = (itInput.value || "").trim();
    if(!text){
      quadraOutput.innerHTML = "";
      return;
    }

    btnTranslate.disabled = true;
    btnTranslate.textContent = "…";

    try{
      const data = await apiTranslate(text);
      const quadra = (data.quadra || "").trim();
      const parsed = Q.parseQuadraString(quadra);
      renderWords(parsed);
    }catch(e){
      quadraOutput.innerHTML = "";
      apiLabel.textContent = "API: errore";
    }finally{
      btnTranslate.disabled = false;
      btnTranslate.textContent = "Translate";
    }
  }

  btnTranslate.addEventListener("click", doTranslate);
  itInput.addEventListener("keydown", (e) => {
    if((e.metaKey || e.ctrlKey) && e.key === "Enter") doTranslate();
  });

  /* init */
  apiHealth();
  renderLegend();
</script>
</body>
</html>