<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quadra Translator</title>

  <!-- Glyph library -->
  <script src="./quadra-glyphs.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#8FA3AE;
      --ink-2:#A7B7C0;
      --hair: rgba(143,163,174,.28);
      --soft: rgba(143,163,174,.08);

      --sans: "Helvetica Neue", Helvetica, Arial, system-ui, -apple-system, Segoe UI, Roboto;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --maxw: 1400px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;
      overflow-x:hidden;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      border-bottom: 1px solid var(--hair);
    }
    .topbar{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 14px 28px 12px 28px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 18px;
    }
    @media (max-width: 980px){
      .topbar{ padding: 14px 18px 12px 18px; }
    }
    .brand{
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ink);
      line-height: 1.1;
    }
    .status{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-2);
      display:flex;
      align-items:center;
      gap: 10px;
      white-space: nowrap;
    }
    .dot{
      width:8px; height:8px;
      border-radius: 999px;
      border: 1px solid var(--hair);
      background: transparent;
    }
    .dot.ok{ background: var(--ink); border-color: var(--ink); }
    .dot.bad{ background: transparent; border-color: var(--ink); }

    /* progress */
    .progressWrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 0 28px 10px 28px;
    }
    @media (max-width: 980px){
      .progressWrap{ padding: 0 18px 10px 18px; }
    }
    .progress{
      height: 2px;
      background: rgba(143,163,174,.18);
      overflow:hidden;
      position: relative;
    }
    .bar{
      height: 100%;
      width: 0%;
      background: var(--ink);
      transform-origin: left;
      transition: width 120ms linear;
    }
    .progress[aria-hidden="true"]{ visibility:hidden; }

    /* main grid */
    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 22px 28px 50px 28px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap: 36px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{
        padding: 18px 18px 40px 18px;
        grid-template-columns: 1fr;
        gap: 22px;
      }
    }

    /* legend */
    aside{
      padding-top: 6px;
      border-right: 1px solid var(--hair);
      padding-right: 18px;
    }
    @media (max-width: 980px){
      aside{
        border-right:none;
        padding-right:0;
        border-bottom: 1px solid var(--hair);
        padding-bottom: 14px;
      }
    }
    .legendTitle{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ink);
      margin-bottom: 12px;
    }
    .legend{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .legendItem{
      display:flex;
      align-items:center;
      gap: 12px;
    }
    .legendItem svg{
      width: 44px;
      height: 44px;
      color: var(--ink);
    }
    .legendName{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--ink);
      line-height: 1.2;
      font-weight: 700;
    }
    .legendDesc{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-2);
      line-height: 1.35;
      margin-top: 3px;
    }

    /* main */
    main{
      padding-top: 6px;
      display:flex;
      flex-direction:column;
      align-items:flex-start; /* fix centering */
      gap: 16px;
    }

    .title{
      margin:0;
      font-size: clamp(44px, 6vw, 92px);
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--ink);
      line-height: .98;
    }
    .desc{
      margin:0;
      max-width: 760px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.6;
      color: var(--ink-2);
    }

    .inputBlock{
      width: min(860px, 100%);
      display:flex;
      flex-direction:column;
      gap: 14px;
      margin-top: 10px;
    }
    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      border: 1px solid var(--hair);
      border-radius: 0;
      outline: none;
      padding: 16px;
      font-family: var(--mono);
      font-size: 13px;
      color: var(--ink);
      background: transparent;
    }
    textarea::placeholder{ color: rgba(143,163,174,.55); }

    button{
      width: min(540px, 100%);
      padding: 18px 18px;
      border: 1px solid var(--ink);
      background: transparent;
      color: var(--ink);
      font-family: var(--sans);
      font-size: 18px;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-weight: 600;
      cursor:pointer;
      transition: transform .04s ease, opacity .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; }

    /* output */
    .out{
      margin-top: 18px;
      width: 100%;
      border-top: 1px solid var(--hair);
      padding-top: 14px;
    }
    .outLabel{
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--ink);
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .err{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--ink-2);
      margin-top: 10px;
      white-space: pre-wrap;
    }

    .quadraLine{
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
      align-items:center;
      min-height: 84px;
      padding: 6px 0 2px 0;
    }
    .word{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .sep{
      font-family: var(--mono);
      color: rgba(143,163,174,.55);
      letter-spacing:.08em;
      user-select:none;
    }

    .fadeIn{ animation: fadeIn .22s ease-out; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(2px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* try to force svg ink if glyphs use currentColor */
    svg{ color: var(--ink); }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">Quadra Translator</div>
    <div class="status">
      <span class="dot" id="apiDot"></span>
      <span id="apiLabel">API: …</span>
    </div>
  </div>
  <div class="progressWrap">
    <div class="progress" id="progress" aria-hidden="true">
      <div class="bar" id="bar"></div>
    </div>
  </div>
</header>

<div class="wrap">
  <aside>
    <div class="legendTitle">Legend</div>
    <div class="legend" id="legend"></div>
    <div class="err" id="glyphErr" style="display:none;"></div>
  </aside>

  <main>
    <h1 class="title">Quadra Translator</h1>
    <p class="desc">
      Quadra non traduce suoni: riduce frasi a intenzioni. Ogni parola diventa una composizione di concetti —
      entità, agenzia, stato, tempo — come una grammatica geometrica che descrive relazioni invece che fonemi.
    </p>

    <div class="inputBlock">
      <textarea id="itInput" placeholder="Scrivi una frase… (es. 'bottiglia piena vicino al luogo')"></textarea>
      <button id="btnTranslate">Translate</button>
    </div>

    <section class="out">
      <div class="outLabel">
        <span>Output Quadra</span>
        <span id="outMeta" style="font-family:var(--mono); font-size:11px; color:var(--ink-2); text-transform:none; letter-spacing:.02em;"></span>
      </div>
      <div class="quadraLine" id="quadraOutput"></div>
      <div class="err" id="err"></div>
    </section>
  </main>
</div>

<script>
  const API_BASE = "https://quadra-api.quadra-fm.workers.dev";

  /* -------------------------
     Robust glyph-lib discovery
     ------------------------- */
  function getGlyphLib(){
    // preferred
    if (window.QUADRA) return window.QUADRA;
    if (window.QuadraGlyphs) return window.QuadraGlyphs;

    // fallback: try to assemble minimal interface if globals exist
    const defs = window.GLYPH_DEFS || window.GLYPH || null;
    const svgGlyph = window.svgGlyph || null;
    const parseQuadraString = window.parseQuadraString || null;

    if(defs && svgGlyph && parseQuadraString){
      return { GLYPH_DEFS: defs, svgGlyph, parseQuadraString };
    }

    return null;
  }

  const Q = getGlyphLib();

  const itInput = document.getElementById("itInput");
  const btnTranslate = document.getElementById("btnTranslate");
  const quadraOutput = document.getElementById("quadraOutput");
  const legendEl = document.getElementById("legend");
  const errEl = document.getElementById("err");
  const glyphErr = document.getElementById("glyphErr");
  const apiDot = document.getElementById("apiDot");
  const apiLabel = document.getElementById("apiLabel");
  const outMeta = document.getElementById("outMeta");

  const progress = document.getElementById("progress");
  const bar = document.getElementById("bar");

  function showGlyphError(msg){
    glyphErr.style.display = "block";
    glyphErr.textContent = msg + "\nControlla quadra-glyphs.js: deve esporre window.QUADRA oppure window.QuadraGlyphs con svgGlyph() e GLYPH_DEFS.";
  }

  /* -------------------------
     Progress bar
     ------------------------- */
  let progTimer = null;
  let progVal = 0;

  function startProgress(){
    stopProgress();
    progVal = 0;
    bar.style.width = "0%";
    progress.setAttribute("aria-hidden","false");
    // grow to 90% while waiting
    progTimer = setInterval(() => {
      progVal = Math.min(90, progVal + (progVal < 60 ? 6 : 2));
      bar.style.width = progVal + "%";
    }, 120);
  }

  function finishProgress(){
    if(progTimer) clearInterval(progTimer);
    progTimer = null;
    bar.style.width = "100%";
    setTimeout(() => {
      progress.setAttribute("aria-hidden","true");
      bar.style.width = "0%";
    }, 220);
  }

  function stopProgress(){
    if(progTimer) clearInterval(progTimer);
    progTimer = null;
    progress.setAttribute("aria-hidden","true");
    bar.style.width = "0%";
  }

  /* -------------------------
     API
     ------------------------- */
  async function apiHealth(){
    try{
      const r = await fetch(`${API_BASE}/`, { method:"GET" });
      const t = await r.text();
      const ok = r.ok && (t || "").includes("quadra-api ok");
      apiDot.className = "dot " + (ok ? "ok" : "bad");
      apiLabel.textContent = ok ? "API: online" : "API: risposta inattesa";
    }catch(e){
      apiDot.className = "dot bad";
      apiLabel.textContent = "API: offline";
    }
  }

  async function apiTranslate(text){
    const r = await fetch(`${API_BASE}/translate`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ text, autosave:false })
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data?.error || "translate_failed");
    return data;
  }

  /* -------------------------
     Rendering
     ------------------------- */
  function legendMeaning(token){
    const map = {
      OGGETTO:"entità oggettuale",
      PERSONA:"agente / persona",
      LUOGO:"spazio / luogo",
      ATTIVO:"agenzia attiva",
      PASSIVO:"agenzia passiva",
      FERMO:"stato stabile",
      MOVIMENTO:"stato dinamico",
      PRESENTE:"presenza / tempo",
      ASSENTE:"assenza (negazione interna)",
      RELAZIONE:"relazione",
      INIZIO:"inizio",
      FINE:"fine",
      CONTENITORE:"contenitore",
      APERTO:"aperto",
      CHIUSO:"chiuso",
      PIENO:"pieno",
      VUOTO:"vuoto",
      DENTRO:"dentro",
      FUORI:"fuori",
      VICINO:"vicino",
      LONTANO:"lontano",
      TRASFORMAZIONE:"trasformazione",
      CAUSA:"causa",
      SCOPO:"scopo",
      POSSESSO:"possesso",
      POSSIBILE:"possibile",
      DOVERE:"dovere"
    };
    return map[token] || "concetto";
  }

  function renderLegend(){
    legendEl.innerHTML = "";
    if(!Q || !Q.GLYPH_DEFS || typeof Q.svgGlyph !== "function"){
      showGlyphError("ERRORE: libreria glifi non rilevata.");
      return;
    }
    const tokens = Object.keys(Q.GLYPH_DEFS);
    tokens.forEach(t => {
      const item = document.createElement("div");
      item.className = "legendItem";
      item.innerHTML = `
        <div>${Q.svgGlyph(t)}</div>
        <div>
          <div class="legendName">${t}</div>
          <div class="legendDesc">${legendMeaning(t)}</div>
        </div>
      `;
      legendEl.appendChild(item);
    });
  }

  function renderWords(parsed){
    quadraOutput.innerHTML = "";
    quadraOutput.classList.remove("fadeIn");

    parsed.forEach((w, idx) => {
      const word = document.createElement("div");
      word.className = "word";
      w.tokens.forEach((t, i) => {
        const cell = document.createElement("div");
        cell.innerHTML = Q.svgGlyph(t, { negate: w.opts?.[i]?.negate === true });
        word.appendChild(cell);
      });
      quadraOutput.appendChild(word);

      if(idx !== parsed.length - 1){
        const sep = document.createElement("div");
        sep.className = "sep";
        sep.textContent = "⟂";
        quadraOutput.appendChild(sep);
      }
    });

    quadraOutput.classList.add("fadeIn");
  }

  /* -------------------------
     Translate
     ------------------------- */
  async function doTranslate(){
    errEl.textContent = "";
    outMeta.textContent = "";
    quadraOutput.innerHTML = "";

    if(!Q || typeof Q.parseQuadraString !== "function" || typeof Q.svgGlyph !== "function"){
      showGlyphError("ERRORE: quadra-glyphs.js non espone le funzioni richieste.");
      return;
    }

    const text = (itInput.value || "").trim();
    if(!text) return;

    btnTranslate.disabled = true;
    startProgress();

    try{
      const data = await apiTranslate(text);
      const quadra = (data.quadra || "").trim();

      outMeta.textContent = (data.from ? `source: ${data.from}` : "");
      const parsed = Q.parseQuadraString(quadra);
      renderWords(parsed);
      finishProgress();
    }catch(e){
      stopProgress();
      errEl.textContent = "Errore traduzione. Controlla API / rete.";
    }finally{
      btnTranslate.disabled = false;
    }
  }

  btnTranslate.addEventListener("click", doTranslate);
  itInput.addEventListener("keydown", (e) => {
    if((e.metaKey || e.ctrlKey) && e.key === "Enter") doTranslate();
  });

  /* init */
  apiHealth();
  renderLegend();

  // demo
  itInput.value = "bottiglia piena vicino al luogo";
</script>
</body>
</html>