<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quadra Translator</title>

  <style>
    :root{
      --bg:#ffffff;
      --ink:#8fa3ad;
      --ink-strong:#7f96a1;
      --line:#c9d6dc;
      --muted:#a6b7bf;
      --pad:28px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: "Helvetica Neue", Helvetica, Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      letter-spacing:0.02em;
    }

    header{
      position:sticky; top:0;
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid #eef2f4;
      padding:18px var(--pad);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      z-index:20;
    }
    .brand{ display:flex; flex-direction:column; gap:4px; }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      font-weight:700;
      color:var(--ink-strong);
    }
    .brand .sub{
      font-size:12px;
      font-family:var(--mono);
      color:var(--muted);
    }

    .tech-btn{
      width:18px; height:18px;
      border:1.5px solid var(--ink);
      background:transparent;
      cursor:pointer;
    }
    .tech-btn:active{ transform: translateY(1px); }

    main{
      padding: var(--pad);
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:28px;
      align-items:start;
    }
    @media (max-width: 960px){
      main{ grid-template-columns: 1fr; }
      .legend{ order:2; }
    }

    .legend{
      border-left:1px solid #f0f3f5;
      padding-left:16px;
      min-height: 60vh;
    }
    .legend h2{
      margin:0 0 12px 0;
      font-size:12px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-weight:700;
      color:var(--ink-strong);
    }
    .legend-list{ display:flex; flex-direction:column; gap:10px; }
    .legend-item{
      display:grid;
      grid-template-columns: 68px 1fr;
      gap:12px;
      align-items:center;
      padding:8px 0;
      border-bottom:1px solid #f5f7f8;
    }
    .legend-item:last-child{ border-bottom:none; }
    .legend-item .name{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    .panel{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height: 60vh;
    }
    .desc{
      max-width: 760px;
      font-size:12px;
      line-height:1.55;
      font-family:var(--mono);
      color:var(--muted);
    }

    textarea{
      width:100%;
      min-height:120px;
      border:1px solid #e6ecef;
      border-radius:12px;
      padding:14px 16px;
      font-family:var(--sans);
      font-size:16px;
      color:var(--ink-strong);
      outline:none;
      resize:vertical;
    }
    textarea::placeholder{ color:#b6c5cc; }

    .actions{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .btn{
      border:1.5px solid var(--ink);
      background:transparent;
      padding:14px 18px;
      border-radius:14px;
      font-family:var(--sans);
      font-weight:700;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--ink-strong);
      cursor:pointer;
      min-width:220px;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .bar-wrap{
      width:100%;
      height:8px;
      border-radius:999px;
      border:1px solid #e6ecef;
      overflow:hidden;
      background:#fff;
    }
    .bar{
      height:100%;
      width:0%;
      background: var(--ink);
      transition: width .18s ease;
    }

    .out{
      margin-top:10px;
      border-top:1px solid #eef2f4;
      padding-top:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .out h2{
      margin:0;
      font-size:12px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      font-weight:700;
      color:var(--ink-strong);
    }
    .quadra-line{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      min-height:76px;
    }
    .word{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border:1px solid #eef2f4;
      border-radius:14px;
      background:#fff;
    }
    .pill{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      padding:4px 8px;
      border:1px solid #eef2f4;
      border-radius:999px;
    }
    .error{
      font-family:var(--mono);
      font-size:12px;
      color:#a66;
    }

    /* NOISE GATE overlay */
    .noise{
      position:fixed;
      inset:0;
      background:#fff;
      z-index:9999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:40px;
    }
    .noise.on{ display:flex; }
    .noise-inner{ width:min(860px, 100%); text-align:center; }
    .noise-title{
      font-size:76px;
      line-height:0.95;
      letter-spacing:0.06em;
      font-weight:800;
      text-transform:uppercase;
      color:var(--ink-strong);
      margin:0 0 18px 0;
    }
    .noise-sub{
      font-family:var(--mono);
      font-size:14px;
      line-height:1.6;
      color:var(--muted);
      margin:0 0 28px 0;
      white-space:pre-line;
    }
    .noise-actions{ display:flex; justify-content:center; }
    .noise-close{
      border:1.5px solid var(--ink);
      background:transparent;
      padding:12px 16px;
      border-radius:14px;
      font-family:var(--sans);
      font-weight:700;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--ink-strong);
      cursor:pointer;
      min-width:220px;
    }

    /* keep glyphs black for clarity */
    svg *{ stroke:#000 !important; fill:#000 !important; }
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <h1>quadra translator</h1>
      <div class="sub">italiano → quadra • concetti, non rumore</div>
    </div>
    <button class="tech-btn" id="btnTech" aria-label="area tecnica"></button>
  </header>

  <div class="noise" id="noiseGate" aria-hidden="true">
    <div class="noise-inner">
      <h2 class="noise-title">NO.</h2>
      <p class="noise-sub">this language is for concepts, not noise.
come back with a thought.</p>
      <div class="noise-actions">
        <button class="noise-close" id="noiseClose">ok</button>
      </div>
    </div>
  </div>

  <main>
    <aside class="legend">
      <h2>Legenda</h2>
      <div class="legend-list" id="legendList"></div>
    </aside>

    <section class="panel">
      <div class="desc">
        Quadra riduce la frase a una composizione di stati, agenzie e relazioni.
        Non descrive “oggetti”: descrive il modo in cui una cosa esiste, agisce, cambia.
      </div>

      <textarea id="itInput" placeholder="Scrivi una frase (concettuale)"></textarea>

      <div class="actions">
        <button class="btn" id="btnTranslate">TRADUCI</button>
      </div>

      <div class="bar-wrap" aria-hidden="true">
        <div class="bar" id="progressBar"></div>
      </div>

      <div class="out">
        <h2>Output</h2>
        <div class="quadra-line" id="quadraOutput"></div>
        <div class="error" id="err"></div>
      </div>
    </section>
  </main>

  <script src="./quadra-glyphs.js"></script>

  <script>
    const API_BASE = "https://quadra-api.quadra-fm.workers.dev";

    const itInput = document.getElementById("itInput");
    const btnTranslate = document.getElementById("btnTranslate");
    const quadraOutput = document.getElementById("quadraOutput");
    const errEl = document.getElementById("err");
    const progressBar = document.getElementById("progressBar");

    const noiseGate = document.getElementById("noiseGate");
    const noiseClose = document.getElementById("noiseClose");
    const btnTech = document.getElementById("btnTech");

    const PROFANITY = [
      "cazzo","cazzi","merda","stronzo","stronzi","troia","puttana","puttane","vaffanculo","porco",
      "fuck","fucking","shit","bitch","asshole","cunt","dick","pussy","wtf","stfu"
    ];

    function normalize(s){
      return (s||"")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[’']/g,"'")
        .trim();
    }
    function containsProfanity(text){
      const t = normalize(text);
      return PROFANITY.some(w => t.includes(w));
    }
    function gibberishToken(tok){
      const t = normalize(tok).replace(/[^a-z]/g,"");
      if(!t) return true;
      if(t.length >= 4 && !/[aeiou]/.test(t)) return true;
      if(/(.)\1\1/.test(t)) return true;
      if(t.length >= 10 && new Set(t.split("")).size <= 3) return true;
      return false;
    }
    function isNoise(text){
      const raw = normalize(text);
      if(!raw) return false;
      if(containsProfanity(raw)) return true;

      const nonLetters = raw.replace(/[a-z\s]/g,"").length;
      const total = raw.length;
      if(total >= 8 && (nonLetters/total) > 0.35) return true;

      const toks = raw.split(/\s+/).filter(Boolean);
      if(toks.length >= 2){
        const gib = toks.filter(gibberishToken).length;
        if((gib/toks.length) >= 0.6) return true;
      }
      return false;
    }

    function showNoiseGate(){
      noiseGate.classList.add("on");
      noiseGate.setAttribute("aria-hidden","false");
    }
    function hideNoiseGate(){
      noiseGate.classList.remove("on");
      noiseGate.setAttribute("aria-hidden","true");
    }
    noiseClose.addEventListener("click", hideNoiseGate);
    noiseGate.addEventListener("click", (e) => { if(e.target === noiseGate) hideNoiseGate(); });

    function renderWords(wordsParsed, targetEl){
      targetEl.innerHTML = "";
      wordsParsed.forEach((w, idx) => {
        const wordWrap = document.createElement("div");
        wordWrap.className = "word";
        w.tokens.forEach((t, i) => {
          const cell = document.createElement("div");
          cell.innerHTML = window.QUADRA.svgGlyph(t, { negate: w.opts[i]?.negate === true });
          wordWrap.appendChild(cell);
        });
        targetEl.appendChild(wordWrap);
        if(idx !== wordsParsed.length - 1){
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = "⟂";
          targetEl.appendChild(pill);
        }
      });
    }

    // Legend
    const legendList = document.getElementById("legendList");
    const LEGEND_ORDER = [
      ["OGGETTO","entità: oggetto"],
      ["PERSONA","entità: persona"],
      ["LUOGO","entità: luogo"],
      ["CONTENITORE","entità: contenitore"],
      ["ATTIVO","agenzia: attivo"],
      ["PASSIVO","agenzia: passivo"],
      ["FERMO","stato: fermo"],
      ["MOVIMENTO","stato: movimento"],
      ["APERTO","stato: aperto"],
      ["CHIUSO","stato: chiuso"],
      ["PIENO","stato: pieno"],
      ["VUOTO","stato: vuoto"],
      ["TRASFORMAZIONE","stato: trasformazione"],
      ["DENTRO","spazio: dentro"],
      ["FUORI","spazio: fuori"],
      ["VICINO","spazio: vicino"],
      ["LONTANO","spazio: lontano"],
      ["PRESENTE","tempo: presente"],
      ["ASSENTE","tempo: assente"],
      ["INIZIO","tempo: inizio"],
      ["FINE","tempo: fine"],
      ["RELAZIONE","relazione"],
      ["CAUSA","logica: causa"],
      ["SCOPO","logica: scopo"],
      ["POSSESSO","logica: possesso"],
      ["POSSIBILE","logica: possibile"],
      ["DOVERE","logica: dovere"]
    ];
    function renderLegend(){
      legendList.innerHTML = "";
      for(const [tok, label] of LEGEND_ORDER){
        const row = document.createElement("div");
        row.className = "legend-item";
        const g = document.createElement("div");
        g.innerHTML = window.QUADRA.svgGlyph(tok);
        const t = document.createElement("div");
        t.className = "name";
        t.textContent = label;
        row.appendChild(g);
        row.appendChild(t);
        legendList.appendChild(row);
      }
    }

    // Progress bar
    let progTimer = null;
    function startProgress(){
      progressBar.style.width = "8%";
      let p = 8;
      progTimer = setInterval(() => {
        p = Math.min(88, p + Math.random()*6);
        progressBar.style.width = p.toFixed(0) + "%";
      }, 120);
    }
    function endProgress(ok=true){
      if(progTimer) clearInterval(progTimer);
      progTimer = null;
      progressBar.style.width = ok ? "100%" : "0%";
      setTimeout(() => { progressBar.style.width = "0%"; }, ok ? 500 : 150);
    }

    async function apiTranslate(text){
      const r = await fetch(`${API_BASE}/translate`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ text, autosave:false })
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data?.error || "translate_failed");
      return data;
    }

    async function doTranslate(){
      errEl.textContent = "";
      quadraOutput.innerHTML = "";

      const text = itInput.value || "";
      if(isNoise(text)){
        showNoiseGate();
        return;
      }

      btnTranslate.disabled = true;
      startProgress();
      try{
        const data = await apiTranslate(text);
        const quadra = String(data.quadra || "").trim();
        const parsed = window.QUADRA.parseQuadraString(quadra);
        renderWords(parsed, quadraOutput);
        endProgress(true);
      }catch(e){
        endProgress(false);
        if(String(e.message || "").includes("noise_blocked")){
          showNoiseGate();
        }else{
          errEl.textContent = "Errore API: impossibile tradurre.";
        }
      }finally{
        btnTranslate.disabled = false;
      }
    }

    btnTranslate.addEventListener("click", doTranslate);
    itInput.addEventListener("keydown", (e) => {
      if((e.metaKey || e.ctrlKey) && e.key === "Enter") doTranslate();
    });

    // Tech area → tech.html (password gate lì dentro)
    btnTech.addEventListener("click", () => {
      location.href = "./tech.html";
    });

    renderLegend();
  </script>
</body>
</html>