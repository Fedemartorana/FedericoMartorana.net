<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Louvre Memory ‚Äî Terminale</title>
  <link rel="stylesheet" href="style/main.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- SCHERMATA TERMINALE INIZIALE -->
<section id="intro" class="screen terminal">
  <div class="terminal-box">
    <div class="line">> Benvenuto nella memoria profonda del Louvre.</div>
    <div class="line">> Seleziona l'epoca che riconosci come tua.</div>
    <div class="line">&nbsp;</div>

    <div id="themeGrid" class="theme-grid-terminal">
      <div class="theme-option" data-value="tema1">[ ] Tema 1</div>
      <div class="theme-option" data-value="tema2">[ ] Tema 2</div>
      <div class="theme-option" data-value="tema3">[ ] Tema 3</div>
      <div class="theme-option" data-value="tema4">[ ] Tema 4</div>
      <div class="theme-option" data-value="tema5">[ ] Tema 5</div>
      <div class="theme-option" data-value="tema6">[ ] Tema 6</div>
      <div class="theme-option" data-value="tema7">[ ] Tema 7</div>
      <div class="theme-option" data-value="tema8">[ ] Tema 8</div>
      <div class="theme-option" data-value="tema9">[ ] Tema 9</div>
      <div class="theme-option" data-value="tema10">[ ] Tema 10</div>
    </div>

    <div class="line">> Inserisci la tua firma:</div>
    <input id="visitorName" class="terminal-input" maxlength="40" autocomplete="off">

    <div class="line">> Scrivi la parte di memoria che riconosci:</div>
    <textarea id="visitorText" class="terminal-input area" rows="5" maxlength="1000"></textarea>

    <button id="submitBtn" class="terminal-btn">CONFERMA</button>
  </div>
</section>

<!-- OVERLAY PERCENTUALE -->
<section id="overlay" class="screen hidden terminal">
  <div class="terminal-box center-box">
    <div id="resultText" class="line"></div>
    <button id="continueBtn" class="terminal-btn">CONTINUA</button>
  </div>
</section>

<!-- DESKTOP -->
<section id="desktop" class="hidden desktop">
  <div id="topbar">ARCHIVIO COMPLETO DELLA MEMORIA</div>
  <div id="iconGrid"></div>
</section>

<script>
// --- SUPABASE INIT ---
const SUPABASE_URL = "https://fxthdtvorfzgrbywyrjn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ4dGhkdHZvcmZ6Z3JieXd5cmpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjM4MjgsImV4cCI6MjA3NzgzOTgyOH0.Tk9HK_CadJ1p8YIJN5RRGforhVsuMxfpEptbhD4bBmM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// TEMI
const EPOCHS = Array.from({length: 10}, (_, i) => ({
  id: `tema${i+1}`,
  name: `Tema ${i+1}`,
  files: [
    {type:'text', name:`tema${i+1}.txt`, src:`media/epoca${i+1}/tema${i+1}.txt`},
    {type:'video', name:'video.mp4', src:`media/epoca${i+1}/video.mp4`}
  ]
}));

let selectedTheme = null;
let userData = {};

// Selezione tema
document.querySelectorAll('.theme-option').forEach(opt => {
  opt.onclick = () => {
    document.querySelectorAll('.theme-option').forEach(o => o.textContent = o.textContent.replace('‚úì',' ').replace('[x]','[ ]'));
    opt.textContent = '[x] ' + opt.textContent.replace('[ ] ','').replace('[x] ','');
    selectedTheme = opt.dataset.value;
  };
});

// Submit
submitBtn.onclick = async () => {
  const nome = visitorName.value.trim();
  const testo = visitorText.value.trim();
  if(!selectedTheme || !nome || !testo) return;

  userData = { tema: selectedTheme, nome, testo };
  await supabase.from('memories').insert([userData]);

  const perc = 10 + Math.min(10, Math.round(testo.length / 20));

  intro.classList.add('hidden');
  overlay.classList.remove('hidden');
  resultText.innerHTML = `> Conosci il Louvre al <b>${perc}%</b>.`;

  openFolder(EPOCHS.find(e => e.id === selectedTheme));
};

continueBtn.onclick = () => {
  overlay.classList.add('hidden');
  showDesktop();
};

function showDesktop(){
  desktop.classList.remove('hidden');
  iconGrid.innerHTML = '';

  EPOCHS.forEach(ep => {
    const icon = document.createElement('div');
    icon.className = 'icon';
    icon.innerHTML = `<div class="glyph">üìÅ</div><div class="name">${ep.name}</div>`;
    icon.onclick = () => openFolder(ep);
    iconGrid.appendChild(icon);
  });

  loadAllMemories();
}

async function loadAllMemories(){
  const { data } = await supabase.from('memories').select('*').order('created_at',{ascending:false});
  data.forEach(mem => {
    const icon = document.createElement('div');
    icon.className = 'icon';
    icon.innerHTML = `<div class="glyph">üìÑ</div><div class="name">ricordo di ${mem.nome}</div>`;
    icon.onclick = () => openUserMemory(mem);
    iconGrid.appendChild(icon);
  });
}

function openFolder(ep){
  const win = document.createElement('div');
  win.className = 'window';
  win.innerHTML = `
    <div class="titlebar">${ep.name}<div class="btn" data-close>X</div></div>
    <div class="content">
      <div class="sidebar" data-files></div>
      <div class="viewer" data-viewer><div style="opacity:.5;">Attendi...</div></div>
    </div>`;
  document.body.appendChild(win);

  const files = win.querySelector('[data-files]');
  const viewer = win.querySelector('[data-viewer]');

  ep.files.forEach(f => {
    const fe = document.createElement('div'); fe.className = 'file'; fe.textContent = f.name;
    fe.onclick = () => openFile(f,viewer);
    files.appendChild(fe);
  });

  win.querySelector('[data-close]').onclick = () => win.remove();
}

async function openFile(f,viewer){
  viewer.innerHTML = '';
  if(f.type==='text'){
    const txt = await (await fetch(f.src)).text();
    const pre = document.createElement('pre'); pre.textContent = txt;
    viewer.appendChild(pre);
  } else {
    const v = document.createElement('video'); v.src=f.src; v.controls=true; v.autoplay=true; viewer.appendChild(v);
  }
}

function openUserMemory(data){
  const win = document.createElement('div'); win.className='window';
  win.innerHTML = `<div class="titlebar">ricordo di ${data.nome}<div class="btn" data-close>X</div></div><div class="viewer-text">${data.testo}</div>`;
  document.body.appendChild(win);
  win.querySelector('[data-close]').onclick = () => win.remove();
}
</script>

</body>
</html>
